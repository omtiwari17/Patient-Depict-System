{% extends 'admin-base.html' %} {% block admin %}

<main class="main-content fade-in">
  <section class="section container reveal">
    <h2 class="h2">‚úèÔ∏è Edit Accounts</h2>

    <!-- ======================= EDIT DOCTOR FORM ======================= -->
    <form
      id="editDoctorForm"
      action="{% url 'admin-update-doctor' %}"
      method="post"
      class="card"
      style="padding: 1.2rem; border-radius: 12px; margin-bottom: 2rem"
    >
      {% csrf_token %}
      <h3 class="accent">ü©∫ Edit Doctor</h3>

      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 0.8rem">
        <div>
          <label for="doctorEmail">Lookup by Email</label>
          <input
            id="doctorEmail"
            name="doctorEmail"
            class="input"
            placeholder="doctor@domain.com"
            required
          />
          <button type="button" class="btn" id="doctorSearchBtn" style="margin-top:.4rem">Search</button>
        </div>
        <div>
          <label for="doctorStatus">Status</label>
          <select id="doctorStatus" name="doctorStatus" class="input">
            <option value="">Select Status</option>
            <option>Active</option>
            <option>Suspended</option>
            <option>On Leave</option>
            <option>Retired</option>
          </select>
        </div>
        <div>
          <label for="doctorId">Doctor ID</label>
          <input
            id="doctorId"
            name="doctorId"
            class="input"
            placeholder="e.g., DOC-2025-0042"
          />
        </div>
        <div>
          <label for="doctorName">Full Name</label>
          <input id="doctorName" name="doctorName" class="input" />
        </div>
        <div>
          <label for="doctorDepartment">Department</label>
          <input
            id="doctorDepartment"
            name="doctorDepartment"
            class="input"
            placeholder="e.g., Cardiology"
          />
        </div>
        <div>
          <label for="doctorSpecialist">Specialist</label>
          <input
            id="doctorSpecialist"
            name="doctorSpecialist"
            class="input"
            placeholder="e.g., Cardiologist"
          />
        </div>
        <div>
          <label for="doctorLicense">License No.</label>
          <input
            id="doctorLicense"
            name="doctorLicense"
            class="input"
            placeholder="e.g., MCI/2025/123456"
          />
        </div>
        <div>
          <label for="doctorExperience">Experience (years)</label>
          <input
            id="doctorExperience"
            name="doctorExperience"
            type="number"
            min="0"
            class="input"
          />
        </div>
        <div>
          <label for="doctorPhone">Phone</label>
          <input
            id="doctorPhone"
            name="doctorPhone"
            class="input"
            placeholder="e.g., +91 55512-34567"
          />
        </div>
      </div>

      <button type="submit" class="btn">Save Doctor Changes</button>
      <div id="doctorEditResponse" style="margin-top: 1rem"></div>
    </form>

    <!-- ======================= EDIT PATIENT FORM ======================= -->
    <form
      id="editPatientForm"
      action="{% url 'admin-update-patient' %}"
      method="post"
      class="card"
      style="padding: 1.2rem; border-radius: 12px"
    >
      {% csrf_token %}
      <h3 class="accent">üßç‚Äç‚ôÇÔ∏è Edit Patient</h3>

      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 0.8rem">
        <div>
          <label for="patientEmail">Lookup by Email</label>
          <input
            id="patientEmail"
            name="patientEmail"
            class="input"
            placeholder="patient@domain.com"
            required
          />
          <button type="button" class="btn" id="patientSearchBtn" style="margin-top:.4rem">Search</button>
        </div>
        <div>
          <label for="patientStatus">Status</label>
          <select id="patientStatus" name="patientStatus" class="input">
            <option value="">Select Status</option>
            <option>Active</option>
            <option>Admitted</option>
            <option>In ICU</option>
            <option>In HDU</option>
            <option>Critical</option>
            <option>Serious</option>
            <option>Stable</option>
            <option>Recovering</option>
            <option>Under Observation</option>
            <option>Outpatient</option>
            <option>Discharged</option>
          </select>
        </div>
        <div>
          <label for="patientId">Patient ID</label>
          <input
            id="patientId"
            name="patientId"
            class="input"
            placeholder="e.g., HB-2025-0012"
          />
        </div>
        <div>
          <label for="patientName">Full Name</label>
          <input id="patientName" name="patientName" class="input" />
        </div>
        <div>
          <label for="patientPhone">Phone</label>
          <input
            id="patientPhone"
            name="patientPhone"
            class="input"
            placeholder="e.g., +91 55598-76543"
          />
        </div>
        <div>
          <label for="patientAge">Age</label>
          <input
            id="patientAge"
            name="patientAge"
            type="number"
            min="0"
            class="input"
          />
        </div>
        <div>
          <label for="patientGender">Gender</label>
          <select id="patientGender" name="patientGender" class="input">
            <option value="">Select</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
            <option>Prefer not to say</option>
          </select>
        </div>
        <div>
          <label for="patientBloodGroup">Blood Group</label>
          <select id="patientBloodGroup" name="patientBloodGroup" class="input">
            <option value="">Select</option>
            <option>O+</option>
            <option>O-</option>
            <option>A+</option>
            <option>A-</option>
            <option>B+</option>
            <option>B-</option>
            <option>AB+</option>
            <option>AB-</option>
          </select>
        </div>
        <div class="full">
          <label for="patientAddress">Address</label>
          <textarea
            id="patientAddress"
            name="patientAddress"
            class="input"
            rows="3"
          ></textarea>
        </div>
        <div>
          <label for="patientDisease">Disease</label>
          <input
            id="patientDisease"
            name="patientDisease"
            class="input"
            placeholder="e.g., Diabetes"
          />
        </div>
        <div>
          <label for="assignedDoctor">Doctor</label>
          <input
            id="assignedDoctor"
            name="assignedDoctor"
            class="input"
            list="doctorList"
          />
        </div>
      </div>

      <button type="submit" class="btn">Save Patient Changes</button>
      <div id="patientEditResponse" style="margin-top: 1rem"></div>
    </form>
  </section>
</main>

<script>
  (function(){
    const $ = (q,s=document)=>s.querySelector(q);
    const doctorBtn = $('#doctorSearchBtn');
    const patientBtn = $('#patientSearchBtn');

    function showMsg(el, text, ok=true){ if(!el) return; el.innerHTML = `<div style="color:${ok?'#2ec4b6':'#e63946'};font-weight:700;">${text}</div>` }

    function fillDoctor(d){
      $('#doctorId').value = d.doc_id || '';
      $('#doctorName').value = d.name || '';
      $('#doctorDepartment').value = d.department || '';
      $('#doctorSpecialist').value = d.specialist || '';
      $('#doctorLicense').value = d.license_no || '';
      $('#doctorExperience').value = d.experience ?? '';
      $('#doctorPhone').value = d.phone || '';
    }

    function fillPatient(p){
      $('#patientId').value = p.patient_id || '';
      $('#patientName').value = p.name || '';
      $('#patientPhone').value = p.phone || '';
      $('#patientAge').value = p.age ?? '';
      $('#patientGender').value = p.gender || '';
      $('#patientBloodGroup').value = p.blood_group || '';
      $('#patientAddress').value = p.address || '';
      $('#patientDisease').value = p.disease || '';
      $('#assignedDoctor').value = (p.doctor && p.doctor.doc_id) ? p.doctor.doc_id : (p.doctor_doc_id || '');
      if (p.status) $('#patientStatus').value = p.status;
    }

    async function getJSON(url){
      const res = await fetch(url, {credentials:'same-origin'});
      return await res.json();
    }

    if (doctorBtn){
      doctorBtn.addEventListener('click', async ()=>{
        const email = $('#doctorEmail').value.trim();
        if(!email) return;
        const data = await getJSON(`{% url 'admin-lookup-doctor' %}?email=${encodeURIComponent(email)}`);
        if (data.ok){ fillDoctor(data.doctor); showMsg($('#doctorEditResponse'), 'Doctor loaded'); }
        else { showMsg($('#doctorEditResponse'), data.error || 'Not found', false); }
      });
    }

    if (patientBtn){
      patientBtn.addEventListener('click', async ()=>{
        const email = $('#patientEmail').value.trim();
        if(!email) return;
        const data = await getJSON(`{% url 'admin-lookup-patient' %}?email=${encodeURIComponent(email)}`);
        if (data.ok){ fillPatient(data.patient); showMsg($('#patientEditResponse'), 'Patient loaded'); }
        else { showMsg($('#patientEditResponse'), data.error || 'Not found', false); }
      });
    }

    // AJAX submit for smoother UX
    function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?decodeURIComponent(m[2]):null; }
    async function ajaxSubmit(form, msgBox){
      const fd = new FormData(form);
      const res = await fetch(form.action, {method:'POST', body:fd, headers:{'X-CSRFToken': getCookie('csrftoken')}, credentials:'same-origin'});
      const data = await res.json();
      showMsg(msgBox, data.message || (data.ok?'Saved':'Failed'), !!data.ok);
    }
    const doctorForm = document.getElementById('editDoctorForm');
    const patientForm = document.getElementById('editPatientForm');
    if (doctorForm){ doctorForm.addEventListener('submit', (e)=>{ e.preventDefault(); ajaxSubmit(doctorForm, document.getElementById('doctorEditResponse')); }); }
    if (patientForm){ patientForm.addEventListener('submit', (e)=>{ e.preventDefault(); ajaxSubmit(patientForm, document.getElementById('patientEditResponse')); }); }
  })();
</script>

{% endblock %}
